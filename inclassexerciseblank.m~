%% step 1: write a few lines of code or use FIJI to separately save the
% nuclear channel of the image Colony1.tif for segmentation in Ilastik

%Already one channel

%% step 2: train a classifier on the nuclei
% try to get the get nuclei completely but separe them where you can
% save as both simple segmentation and probabilities

%Done in ilastik

%% step 3: use h5read to read your Ilastik simple segmentation
% and display the binary masks produced by Ilastik 

data_segmented = h5read('Label1.h5', '/exported_data');
data_segmented = squeeze(data_segmented);
imshow(data_segmented, [])

% (datasetname = '/exported_data')
% Ilastik has the image transposed relative to matlab
% values are integers corresponding to segmentation classes you defined,
% figure out which value corresponds to nuclei

%% step 3.1: show segmentation as overlay on raw data

figure;
image = imread('Colony1.tif');
imshow(image, []);
hold on;
imshow(data_segmented, []);
hold off;


%% step 4: visualize the connected components using label2rgb
% probably a lot of nuclei will be connected into large objects

redgreenblue = label2rgb(image);
imshow(redgreenblue)

%% step 5: use h5read to read your Ilastik probabilities and visualize

% it will have a channel for each segmentation class you defined
probability = h5read('Prediction for Label 1.h5', '/exported_data');
probability = squeeze(probability);
imshow(probability, [])


%% step 6: threshold probabilities to separate nuclei better

threshold = probability > 0.75;
imshow(threshold)

%% step 7: watershed to fill in the original segmentation (~hysteresis threshold)

CC = bwconncomp();
stats = regionprops(CC, 'Area');
area = (stats.Area);
s = round(1.2*sqrt(mean(area))/pi);
eroded = imerode(binarymask, strel('disk',s));
outside = ~imdilate(binarymask, strel('disk',1));
basin = imcomplement(bwdist(outside));
basin = imimposemin(basin,eroded|outside);
L = watershed(basin);
imshow(L, [])

%% step 8: perform hysteresis thresholding in Ilastik and compare the results
% explain the differences

thresholding hysterises

%% step 9: clean up the results more if you have time 
% using bwmorph, imopen, imclose etc

